---
title: "SNAP and Cost Structure Analysis"
author: "Mutsa Mungoshi"
date: "2025-07-21"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    theme: flatly
    highlight: tango
    df_print: paged
    code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo        = TRUE,
  message     = FALSE,
  warning     = FALSE,
  fig.width   = 7,
  fig.height  = 5,
  fig.align   = "center",
  fig.retina  = 2  # High-resolution plots for clarity
)
library(tidyverse)
library(janitor)
library(ggplot2)
library(gridExtra)
library(car)
library(reshape2)
library(factoextra)
library(broom)
library(tigris)
library(sf)
library(glue)
library(kableExtra)
library(cluster)
```
<div style="max-width: 1200px; margin: auto;">
## Introduction
This report explores whether participation in the Supplemental Nutrition Assistance Program (SNAP) reflects or reshapes local cost structures across U.S. counties. Specifically, we examine whether higher SNAP participation rates are associated with disproportionate cost burdens or shifts in expenditure patterns across major household categories such as food, housing, healthcare, and transportation.
To investigate these dynamics, we apply a suite of statistical techniques including regression diagnostics, correlation analysis, principal component analysis (PCA), and clustering. These methods allow us to identify underlying cost structure profiles, detect multicollinearity, reduce dimensionality, and group counties with similar cost patterns. Our goal is to better understand how SNAP intensity correlates with, or potentially contributes to, differentiated economic realities at the local level.


## Data Loading & Preparation
```{r prepare-county-level-data, message=FALSE, warning=FALSE}
library(tidyverse)
library(readr)

# Load data
df_raw <- read_csv("data.csv")

# Clean column names if needed
names(df_raw) <- gsub("state_abv\\.", "state_abv", names(df_raw))

# Fix: convert FIPS to character before grouping
df_raw <- df_raw %>%
  filter(!is.na(fips)) %>%
  mutate(fips = as.character(fips))

# Aggregate to county-level by averaging cost components across families
df <- df_raw %>%
  group_by(fips) %>%
  summarise(
    snap_rate             = first(snap_rate),
    median_family_income  = first(median_family_income),
    ismetro               = first(ismetro),
    state_abv             = first(state_abv),
    food                  = mean(food, na.rm = TRUE),
    housing               = mean(housing, na.rm = TRUE),
    transportation        = mean(transportation, na.rm = TRUE),
    healthcare            = mean(healthcare, na.rm = TRUE),
    childcare             = mean(childcare, na.rm = TRUE),
    taxes                 = mean(taxes, na.rm = TRUE),
    other_necessities     = mean(other_necessities, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    total             = food + housing + transportation + healthcare + childcare + taxes + other_necessities,
    food_share        = food / total,
    housing_share     = housing / total,
    transport_share   = transportation / total,
    health_share      = healthcare / total,
    childcare_share   = childcare / total,
    tax_share         = taxes / total
  )

# Check it worked
nrow(df)  # Should now be 3144
str(df)
```
**Interpretation:** 
Cost categories normalized as shares of total expenditures allow meaningful cross-county comparisons.


## Exploratory Visualization & Normality Checks
```{r better-plots, message=FALSE, warning=FALSE, fig.width=6, fig.height=8}
library(ggplot2)
library(gridExtra)

share_vars <- c("food_share", "housing_share", "transport_share",
                "health_share", "childcare_share", "tax_share")

for (v in share_vars) {
  hist_plot <- ggplot(df, aes_string(v)) +
    geom_histogram(bins = 30, fill = "#2C3E50", color = "white", alpha = 0.9) +
    labs(title = paste("Histogram of", v), x = v, y = "Count") +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      axis.title = element_text(face = "bold")
    )

  qq_plot <- ggplot(df, aes_string(sample = v)) +
    stat_qq(color = "#2C3E50") +
    stat_qq_line(color = "#E74C3C", linetype = "dashed") +
    labs(title = paste("Q-Q Plot of", v), x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      axis.title = element_text(face = "bold")
    )

  # ✅ Explicitly print the arranged plots
  print(grid.arrange(hist_plot, qq_plot, ncol = 1,
                     top = paste("Distribution of", v)))
}
```
**Interpretation:** 
Several cost share distributions exhibit skewness and depart from normality—important for subsequent modeling choices.
```{r}
# Load knitr for table display
library(knitr)

# Create the summary table
summary_table <- data.frame(
  Variable = c("food_share", "housing_share", "transport_share", "health_share", 
               "childcare_share", "tax_share"),
  Shape = c("Mild skew", "Right-skewed", "Heavily skewed", "Symmetric", 
            "Mild skew", "Right-skewed"),
  Normality = c("Close", "No", "No", "Yes", "Close", "No"),
  `Transformation Suggested?` = c("Optional", "Yes (log/sqrt)", "Yes (log)", 
                                  "No", "Optional (log/sqrt)", "Yes (log or Box-Cox)")
)

# Print as a nice table
kable(summary_table, caption = "Distribution Summary of Cost Share Variables")

```


```{r}
# Apply log transformations to skewed variables
df <- df %>%
  mutate(
    log_housing_share   = log(housing_share),
    log_transport_share = log(transport_share),
    log_tax_share       = log(tax_share)
  )

# Focus only on variables you log-transformed
log_vars <- c("housing_share", "transport_share", "tax_share")

# Loop to compare original and log-transformed versions
for (v in log_vars) {
  log_v <- paste0("log_", v)
  
  hist_orig <- ggplot(df, aes_string(v)) +
    geom_histogram(bins = 30, fill = "#2C3E50", color = "white", alpha = 0.9) +
    labs(title = paste("Histogram of", v), x = v, y = "Count") +
    theme_minimal(base_size = 12)

  qq_orig <- ggplot(df, aes_string(sample = v)) +
    stat_qq(color = "#2C3E50") +
    stat_qq_line(color = "#E74C3C", linetype = "dashed") +
    labs(title = paste("Q-Q Plot of", v)) +
    theme_minimal(base_size = 12)

  hist_log <- ggplot(df, aes_string(log_v)) +
    geom_histogram(bins = 30, fill = "#1ABC9C", color = "white", alpha = 0.9) +
    labs(title = paste("Histogram of", log_v), x = log_v, y = "Count") +
    theme_minimal(base_size = 12)

  qq_log <- ggplot(df, aes_string(sample = log_v)) +
    stat_qq(color = "#1ABC9C") +
    stat_qq_line(color = "#E74C3C", linetype = "dashed") +
    labs(title = paste("Q-Q Plot of", log_v)) +
    theme_minimal(base_size = 12)

  grid.arrange(hist_orig, qq_orig, hist_log, qq_log, ncol = 2,
               top = paste("Original vs. Log-Transformed:", v))
}
```

## Baseline VIF: General Predictors
```{r vif-baseline}
base_mod <- lm(total ~ snap_rate + median_family_income + ismetro + state_abv, data = df)
print(vif(base_mod))
```
**Interpretation:** 
The table reports Variance Inflation Factors (VIF) for the baseline regression model predicting total household cost using SNAP participation rate, median family income, metro status, and state fixed effects.snap_rate and median_family_income have adjusted VIFs of 1.55 and 1.69, respectively. These values are well below the commonly used thresholds (5 or 10) and suggest only mild correlation with other predictors. No multicollinearity concerns are present.ismetro, with an adjusted VIF of 1.21, also exhibits low collinearity and contributes independently to the model.state_abv, a categorical variable with 50 levels, yields a generalized VIF (GVIF) that is adjusted for degrees of freedom. The adjusted GVIF value is 1.01, indicating essentially no multicollinearity from state-level fixed effects.Conclusion: All predictors fall within acceptable multicollinearity limits. The model is well-specified with respect to independent variation across covariates.

## Correlation Analysis: Cost Shares
```{r corr-heatmap}
log_share_vars <- c("food_share", "log_housing_share", "log_transport_share",
                    "health_share", "childcare_share", "log_tax_share")

corr_mat <- cor(df %>% select(all_of(log_share_vars)), use = "complete.obs")
corr_melt <- melt(round(corr_mat, 2))
ggplot(corr_melt, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = value)) +
  scale_fill_gradient2(low = "#6D9EC1", mid = "white", high = "#E46726", midpoint = 0.5) +
  theme_minimal() +
  labs(title = "Correlation Heatmap (Log-Adjusted Shares)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
**Interpretation:** 
Evident strong correlations (e.g., housing vs. other shares) underscore multicollinearity that PCA will address.
Key Takeaways
Two Major Cost Axes
Housing vs. Transport (r ≈ −0.61): Urban, high-housing counties versus rural, high-transport counties.
Food vs. Non-Food Categories: Food share trades off against childcare and taxes.
Health and Childcare Trade-Off
Health share is strongly negatively correlated with both housing and childcare, suggesting distinctive “health-heavy” counties.
Tax Share Behavior
Tax burden moves oppositely with most living-cost shares (food, transport, health), but positively with childcare—perhaps reflecting counties with generous services funded by higher taxes.
These patterns confirm substantial multicollinearity and dimension reduction justification: we need PCA to capture these compensating expenditure structures in a few orthogonal components.

```{r}
library(knitr)
library(tibble)

# Create interpretation table as a tibble
corr_interpret <- tribble(
  ~Pair, ~Correlation, ~Interpretation,
  "food_share vs log_housing_share",       -0.29, "Counties that spend more on food tend to spend somewhat less on housing.",
  "food_share vs log_transport_share",      0.47, "Higher food shares moderately associate with higher transport shares (e.g., rural areas).",
  "food_share vs health_share",             0.18, "A weak positive link: counties with higher food share spend slightly more on health.",
  "food_share vs childcare_share",         -0.47, "Strong inverse: high food-cost counties spend less on childcare.",
  "food_share vs log_tax_share",           -0.45, "Higher food shares are linked to lower tax shares.",
  "log_housing_share vs log_transport_share", -0.61, "Counties with high housing cost shares spend less on transport, and vice versa.",
  "log_housing_share vs health_share",     -0.66, "Strong negative correlation between housing and health spending shares.",
  "log_housing_share vs childcare_share",   0.17, "Modest positive: high housing counties spend somewhat more on childcare.",
  "log_housing_share vs log_tax_share",     0.18, "Weak positive link: higher housing cost shares associate with slightly higher tax shares.",
  "log_transport_share vs health_share",    0.42, "Counties with high transport shares also tend to spend more on health.",
  "log_transport_share vs childcare_share", -0.52, "Transport-heavy counties tend to spend less on childcare.",
  "log_transport_share vs log_tax_share",  -0.60, "High transport-share counties devote a smaller share to taxes.",
  "health_share vs childcare_share",       -0.59, "Counties emphasizing healthcare spend relatively less on childcare.",
  "health_share vs log_tax_share",         -0.38, "Moderate inverse link between health spending and tax share.",
  "childcare_share vs log_tax_share",       0.34, "Counties spending more on childcare also tend to have higher tax shares."
)

# Display the table
kable(corr_interpret, caption = "Interpretation of Pairwise Correlations Among Log-Adjusted Cost Shares")

```

## VIF Among Cost Shares
```{r vif-costshares}
# VIF loop with transformed variables
for (resp in log_share_vars) {
  preds <- setdiff(log_share_vars, resp)
  model <- lm(as.formula(paste(resp, "~", paste(preds, collapse = "+"))), data = df)
  cat("VIF for", resp, ":\n")
  print(vif(model))
}

```
**Interpretation:**
food_share exhibits the highest VIF values, suggesting strong linear dependencies with housing, transport, and health cost shares. This makes sense, as counties likely balance budgets across these essentials.
All other predictors fall under the conventional VIF threshold of 10, and most are under 5, indicating that multicollinearity is manageable for PCA and regression.
Transforming skewed variables using log transformation helped lower VIFs overall compared to the untransformed case.
Conclusion:
While food_share still has some multicollinearity concerns, the log transformations generally improved stability across predictors. You can proceed confidently with PCA and clustering, keeping an eye on how food_share loads onto components and clusters.
```{r}
library(knitr)

vif_summary <- data.frame(
  Dependent_Variable = c("food_share", "log_housing_share", "log_transport_share",
                         "health_share", "childcare_share", "log_tax_share"),
  Highest_VIF = c(7.98, 2.06, 4.48, 3.27, 3.11, 4.78),
  Variables_with_VIF_over_5 = c("log_housing, log_transport, health",
                                "None",
                                "None",
                                "None",
                                "None",
                                "None"),
  Interpretation = c("Substantial multicollinearity; overlaps heavily with housing and transport.",
                     "No serious multicollinearity; relatively orthogonal.",
                     "Moderate multicollinearity with health and childcare.",
                     "Acceptable multicollinearity.",
                     "Modest multicollinearity; driven by housing and transport.",
                     "Near the upper limit; mainly with housing and health.")
)

kable(vif_summary, caption = "VIF Summary Table: Log-Transformed Cost Shares and food_share")

```

## Principal Component Analysis (PCA)
```{r pca}
# Prepare PCA input data
pca_df <- drop_na(df, all_of(log_share_vars)) %>%
  select(all_of(log_share_vars))

# Run PCA
pca <- prcomp(pca_df, scale. = TRUE)

# Scree plot and variable contribution
print(fviz_eig(pca, addlabels = TRUE))
print(
  fviz_pca_var(pca, 
               col.var = "contrib", 
               gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
               repel = TRUE)
)

# PCA summary
summary(pca)
round(pca$rotation[, 1:3], 2)
```
**Interpretation:** 
The scree plot indicates that the first principal component (PC1) explains 52.2% of the variance in the cost share variables, followed by PC2 (17.6%) and PC3 (12.8%). Combined, the first three components capture approximately 83% of the total variance, suggesting that they sufficiently summarize the multidimensional structure of the data and are appropriate for dimensionality reduction and clustering.

The PCA biplot shows how individual cost share variables contribute to the first two principal components:

PC1 appears to represent an overall contrast between food, transport, and health shares (positively loaded) versus housing, childcare, and tax shares (negatively loaded). Counties with high PC1 scores may have relatively higher food and health burdens and lower housing and childcare costs.
PC2 emphasizes a contrast between housing share (strong positive loading) and health and tax shares (negative loadings), suggesting a dimension driven by housing cost burden.
PC3, while not shown in the biplot, is highly influenced by childcare share (positive loading of 0.72), distinguishing counties with relatively higher childcare burden.

```{r}
# Extract first 3 PCs and round
pca_loadings <- round(pca$rotation[, 1:3], 2)

# Convert to a data frame
pca_tbl <- as.data.frame(pca_loadings) %>%
  rownames_to_column("Variable")

# Use knitr::kable to render as a table
knitr::kable(pca_tbl, caption = "PCA Loadings: Contribution of Variables to PC1–PC3") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```

## Regression on PCA Scores
```{r regression-pca}
# Create new dataframe with PCA scores and predictors
df_pcs <- drop_na(df, all_of(log_share_vars)) %>%
  bind_cols(as_tibble(pca$x[, 1:3]) %>% set_names(c('PC1','PC2','PC3')))

# Run regressions on each PC
results <- map_dfr(c('PC1','PC2','PC3'), function(pc) {
  mod <- lm(as.formula(paste(pc, "~ snap_rate + median_family_income + ismetro + state_abv")), data = df_pcs)
  tidy(mod) %>% filter(term == 'snap_rate') %>%
    mutate(PC = pc, R2 = glance(mod)$r.squared)
})

# Print table and plot
print(results)
print(
  ggplot(results, aes(PC, estimate)) +
    geom_col() +
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
    labs(title = "SNAP Rate Effect on PCA Components", y = "Estimate") +
    theme_minimal()
)
```
**Interpretation:** 
SNAP Rate Effects on Principal Components
The bar plot and regression results illustrate how SNAP participation rates are associated with underlying patterns of county-level cost structure, captured via Principal Component Analysis (PCA). The first three principal components (PC1–PC3) collectively explain over 82.5% of the total variance in cost shares.

🔹 PC1 (Explains 52.2% of Variance)

Estimate: -2.89
p-value: < 0.001 (extremely significant)
R²: 0.80
Interpretation: Higher SNAP rates are strongly and negatively associated with PC1. Since PC1 loads positively on food, transport, and health share, and negatively on housing, tax, and childcare, this suggests that counties with higher SNAP participation tend to spend a lower share on food and health, and relatively more on housing and childcare. This may reflect structural burdens or unmet needs in high-SNAP areas.

🔹 PC2 (Explains 17.6% of Variance)

Estimate: +0.92
p-value: < 0.001
R²: 0.69
Interpretation: SNAP rate is positively associated with PC2. PC2 contrasts housing share (positive loading) with health and tax shares (negative loading). Thus, counties with higher SNAP rates are associated with elevated housing cost shares, while health and tax cost shares are relatively suppressed. This points to a cost structure in which basic shelter takes precedence over healthcare/tax burdens.

🔹 PC3 (Explains 12.8% of Variance)

Estimate: -1.13
p-value: < 0.001
R²: 0.58
Interpretation: SNAP rate is negatively associated with PC3, which primarily contrasts childcare share (positive loading) with housing and health (negative loadings). This implies that counties with higher SNAP rates tend to have lower childcare cost shares, potentially due to lower access or subsidized childcare.

✳️ Summary
Across all components:

SNAP rate shows significant associations with all three principal components.
These associations reveal systematic differences in cost structure among counties with varying SNAP participation.
The strongest effect is seen on PC1, indicating that SNAP may reshape the balance of basic spending needs—reducing food and healthcare burdens while increasing structural or housing burdens.

## Residual Diagnostics
```{r residuals}
# Residual diagnostics for regression on log-based PCA components
for (pc in c('PC1','PC2','PC3')) {
  mod <- lm(as.formula(paste(pc, "~ snap_rate + median_family_income + ismetro + state_abv")), data = df_pcs)
  print(
    ggplot(augment(mod), aes(x = snap_rate, y = .resid)) +
      geom_point(alpha = 0.3) +
      geom_smooth(method = 'loess', se = FALSE, color = 'red') +
      labs(title = paste(pc, 'Residuals vs SNAP Rate'),
           x = "SNAP Participation Rate", y = "Residuals") +
      theme_minimal()
  )
}
```
**Interpretation:** 
Residual Diagnostics: PCA Components Regressed on SNAP Rate
To evaluate whether the relationship between SNAP participation and each principal component (PC1, PC2, PC3) was well-captured by the linear regression models, we plotted the residuals of each model against the predictor snap_rate. The red line in each plot shows a LOESS (locally estimated scatterplot smoothing) curve to capture any non-linear trends.

PC1 Residuals vs SNAP Rate

The residuals are fairly symmetrically distributed around zero, with some widening at higher SNAP rates.
The red LOESS curve shows a slight U-shape, suggesting a minor non-linear pattern: the model slightly underpredicts PC1 scores at both very low and very high SNAP rates.
Implication: While the linear model captures the main trend, there may be mild non-linear effects or heteroscedasticity (variance increasing with SNAP rate), indicating that a non-linear term (e.g., quadratic SNAP rate) might improve model fit slightly.
PC2 Residuals vs SNAP Rate

The residuals are tightly centered around zero but exhibit a slight downward curvature at high SNAP rates.
The red LOESS line dips at the right tail, indicating that the model may overpredict PC2 scores in counties with high SNAP participation.
Implication: The effect of SNAP on PC2 may vary across the range of participation, again hinting at some non-linearity not fully captured by the linear model.
PC3 Residuals vs SNAP Rate

The residuals are more homoscedastic and scattered around zero throughout the range of SNAP rates.
The LOESS curve is nearly flat, with only a very subtle upward trend on the right, indicating minimal deviation from linearity.
Implication: The linear model for PC3 appears well-specified. No strong evidence of systematic non-linear effects.
Conclusion
Across all three components, residuals are generally well-behaved, but mild curvature in the LOESS lines for PC1 and PC2 suggests that non-linear terms could potentially improve model performance for those components. No major outliers or influential observations are visible, indicating reasonable model assumptions for linear regression are met.

## Clustering Analysis & Comparison
```{r clustering, results='asis', echo=FALSE}
# Scale PCA data
scaled <- scale(pca_df)  # pca_df was created using log_share_vars

# Optimal number of clusters
set.seed(123); samp <- scaled[sample(nrow(scaled), 2000),]
print(fviz_nbclust(samp, kmeans, method = 'wss'))
print(fviz_nbclust(samp, kmeans, method = 'silhouette'))
gap <- clusGap(samp, FUN = kmeans, K.max = 10, B = 50)
print(fviz_gap_stat(gap))

# Try k = 2 to 4 clusters
for (k in 2:4) {
  km <- kmeans(scaled[, 1:3], centers = k, nstart = 25)
  df_k <- df %>% drop_na(all_of(log_share_vars)) %>%
    mutate(cluster = factor(km$cluster))

  # PCA scatterplot with clusters
  print(
    ggplot(bind_cols(as_tibble(pca$x[, 1:2]), cluster = df_k$cluster),
           aes(PC1, PC2, color = cluster)) +
      geom_point(alpha = 0.6) +
      labs(title = paste('K-means Clustering (k =', k, ')')) +
      theme_minimal()
  )

  # Cluster-wise averages of cost shares
  print(
    df_k %>%
      group_by(cluster) %>%
      summarise(across(all_of(log_share_vars), ~ round(mean(.x, na.rm = TRUE), 3))) %>%
      knitr::kable(caption = glue::glue("Average log-adjusted shares by cluster k = {k}")) %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  )

  # Boxplot of SNAP rate by cluster
  print(
    ggplot(df_k, aes(cluster, snap_rate, fill = cluster)) +
      geom_boxplot() +
      theme_minimal() +
      labs(title = paste("SNAP Rate by Cluster (k =", k, ")"))
  )
}

# Hierarchical clustering on PCs
dist_mat <- dist(scaled[, 1:3])
hc <- hclust(dist_mat, method = 'ward.D2')
plot(hc, hang = -1, main = 'Hierarchical Clustering Dendrogram')
rect.hclust(hc, k = 3)

# Compare k-means and hierarchical (k = 3)
km3 <- kmeans(scaled[, 1:3], centers = 3, nstart = 25)
df_comp <- df %>%
  drop_na(all_of(log_share_vars)) %>%
  mutate(cluster_k = factor(km3$cluster),
         cluster_h = factor(cutree(hc, 3)))

print(table(KMeans = df_comp$cluster_k, Hier = df_comp$cluster_h))
print(
  ggplot(df_comp, aes(cluster_k, fill = cluster_h)) +
    geom_bar(position = 'dodge') +
    theme_minimal() +
    labs(title = "Cluster Comparison: K-means vs Hierarchical")
)
```

Choosing the Optimal Number of Clusters
To determine the most appropriate number of clusters (K), we evaluated three different methods:

Silhouette Method: The silhouette coefficient peaked at K = 2, suggesting that two clusters produce the most internally coherent and well-separated groupings. However, this configuration may oversimplify the diversity of county cost structures and obscure meaningful subgroups.
Gap Statistic: The gap statistic indicated K = 5 as the optimal number, as it yielded the largest gap between observed and expected within-cluster dispersion under a null reference distribution. This suggests a higher potential for nuanced subgroupings, albeit with diminishing returns in interpretability.
Elbow Method (if used): Visual inspection of the elbow plot showed a bend around K = 3, indicating a reasonable balance between model complexity and explained variation.
Considering these results, we selected K = 3 as a compromise solution for clustering. This choice balances the internal cohesion of the silhouette method, the richer granularity suggested by the gap statistic, and the pragmatic clarity of a three-group solution.

Comparison of Clustering Methods
We applied both K-means and Hierarchical Clustering (with complete linkage) using K = 3. The comparative bar chart above illustrates how cluster assignments differ between methods.

K-means provided more clearly separated and compact clusters based on PCA-reduced features.
Hierarchical clustering produced overlapping groupings, suggesting some counties may lie on the boundary between cost structures.
While both approaches capture meaningful segmentation, K-means appears to offer more consistent and interpretable clustering for our purposes. Future work may explore K = 2 or K = 5 to evaluate whether policy-relevant distinctions emerge at different levels of granularity.

```{r cluster-map, fig.width=10, fig.height=6}
# Ensure required packages are loaded
library(tigris)
library(sf)
library(ggplot2)
library(dplyr)
options(tigris_use_cache = TRUE, tigris_class = "sf")

# Load shapefiles
counties_sf <- counties(cb = TRUE, year = 2020)
states_sf   <- states(cb = TRUE, year = 2020)

# Prepare cluster data (df_comp must include fips and cluster_k)
df_comp <- df_comp %>%
  mutate(fips = stringr::str_pad(fips, width = 5, pad = "0"))

# Join with shapefile using fips
map_df <- counties_sf %>%
  mutate(fips = GEOID) %>%
  left_join(df_comp, by = "fips") %>%
  filter(!is.na(cluster_k), !STATEFP %in% c("02", "15", "72"))  # Exclude AK, HI, PR

# Draw map
ggplot() +
  geom_sf(data = map_df, aes(fill = cluster_k), color = NA) +
  geom_sf(data = states_sf, fill = NA, color = "white", size = 0.2) +
  scale_fill_brewer(palette = "Set2", name = "Cluster") +
  coord_sf(xlim = c(-130, -65), ylim = c(24, 50), expand = FALSE) +
  labs(title = "U.S. County Clusters Based on Adjusted Cost Shares",
       subtitle = "K-means Clustering (Using Log-Adjusted Cost Structure)") +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.title = element_text(size = 11)
  )
```
U.S. County Clusters Based on Adjusted Cost Shares
The map above presents the results of K-means clustering (K = 3) applied to U.S. counties using log-transformed cost share variables. Each county is assigned to one of three clusters based on its relative allocation of spending across key cost-of-living categories (e.g., food, housing, transportation, healthcare, taxes).

Cluster Interpretations:

Cluster 1 (Green):
These counties tend to represent moderate-cost regions with balanced expenditure shares across categories. They are geographically widespread, covering much of the Midwest, interior South, and parts of the Mountain West. The distribution suggests these counties do not exhibit extremes in any particular cost category, making them archetypal of the national median.
Cluster 2 (Orange):
This cluster is concentrated in lower-cost, often rural or semi-rural regions, particularly across the South, Great Plains, and interior Northeast. Counties in this group are characterized by higher food and transportation shares, which may reflect lower housing costs and less access to urban infrastructure. This group also includes many counties with elevated SNAP participation rates, pointing to economic vulnerability.
Cluster 3 (Purple/Blue):
These counties are mostly located in high-cost urban or coastal regions, including the Northeast corridor, West Coast, and parts of Florida and Colorado. They are marked by higher shares for housing and taxes, and typically lower shares for transportation, reflecting dense metro settings with higher living expenses and lower commuting distances. These areas may also have stronger public services and cost burdens that aren’t evenly offset by SNAP.
Implications:

The geographic spread of the clusters underscores the importance of regional variation in cost structures, even after controlling for total spending via log-transformation.
Cluster 2's alignment with SNAP participation patterns may indicate where assistance plays a larger role in the local economic fabric.
Policymakers might consider tailoring assistance programs not just by income, but by cost structure cluster, as similar income levels can imply very different financial realities in different clusters.

```{r map-snap-rate, fig.width=10, fig.height=6}
# Filter counties with non-missing SNAP rate
map_snap <- map_df %>% filter(!is.na(snap_rate))

# Gradient map of SNAP participation
ggplot() +
  geom_sf(data = map_snap, aes(fill = snap_rate), color = NA) +
  geom_sf(data = states_sf, fill = NA, color = "white", size = 0.2) +
  scale_fill_viridis_c(name = "SNAP Rate", option = "C", direction = -1) +
  coord_sf(xlim = c(-130, -65), ylim = c(24, 50), expand = FALSE) +
  labs(
    title = "SNAP Participation Rates by County",
    subtitle = "Higher SNAP Rate = Darker Color"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.title = element_text(size = 11)
  )
```

SNAP Participation Rates by County
The map above displays the county-level SNAP (Supplemental Nutrition Assistance Program) participation rates across the contiguous United States. The shading reflects the proportion of the population receiving SNAP benefits, with darker colors indicating higher participation rates.

Key Observations:

High Participation Regions (Dark Purple/Black):
Notably high SNAP rates are seen in parts of the South, including Mississippi, Louisiana, Georgia, South Carolina, and parts of Arkansas. These areas often exhibit persistent poverty, limited economic opportunities, and higher eligibility for public assistance.
Southwest Texas, parts of New Mexico, and rural Arizona also show deep concentrations of high SNAP usage.
Several counties in central and upstate New York, Appalachia (especially in Kentucky and West Virginia), and urban cores in the Midwest show elevated rates as well.
Moderate Participation Areas (Orange to Red Shades):
Much of the Midwest, interior West, and Northern Plains fall into the middle range of SNAP rates, suggesting moderate economic need or variability based on local policy access and administrative enrollment factors.
Low Participation Regions (Yellow to Light Orange):
Upper Midwest states like Iowa, Minnesota, and parts of the Dakotas exhibit relatively low SNAP rates.
Many counties across Utah, Colorado, and Nebraska, along with some wealthier suburban areas in the Northeast and Pacific Coast, show light shading, indicating lower dependence on SNAP benefits, possibly due to higher median incomes and stricter eligibility screening.
Spatial Patterns:

SNAP participation is not evenly distributed, highlighting both regional disparities in economic conditions and variation in state/local implementation and outreach.
There is a distinct rural-urban divide, where some rural counties have very high rates (especially in the Deep South and tribal lands), while others have very low rates (e.g., rural Utah).
Urban counties in high-cost states (e.g., California, New York, Illinois) display moderate to high SNAP usage, reflecting both high living costs and broader safety net program availability.
Analytical Implications:

This spatial variation is crucial when analyzing how SNAP participation may shape or reflect local cost structures. For instance:

Counties with high SNAP usage may also show different cost share patterns (e.g., larger food cost burdens).
These rates may correlate with cost cluster groupings from the K-means analysis, offering potential insight into how assistance programs interact with regional economic ecosystems.

```{r map-clusters-faceted-metro, fig.width=12, fig.height=7}
# Ensure ismetro is labeled properly (handle NA values if present)
map_df <- map_df %>%
  mutate(metro_label = case_when(
    ismetro == TRUE  ~ "Metro",
    ismetro == FALSE ~ "Non-Metro",
    TRUE             ~ "Unknown"
  ))

# Faceted map showing clusters by metro status
ggplot() +
  geom_sf(data = map_df, aes(fill = cluster_k), color = NA) +
  geom_sf(data = states_sf, fill = NA, color = "white", size = 0.2) +
  scale_fill_brewer(palette = "Set2", name = "Cluster") +
  coord_sf(xlim = c(-130, -65), ylim = c(24, 50), expand = FALSE) +
  facet_wrap(~metro_label) +
  labs(
    title = "Clusters by Metro vs Non-Metro Counties",
    subtitle = "Faceted View by IsMetro Variable"
  ) +
  theme_void() +
  theme(
    strip.text     = element_text(size = 12),
    plot.title     = element_text(size = 16, face = "bold"),
    plot.subtitle  = element_text(size = 12),
    legend.title   = element_text(size = 11)
  )
```
Cluster Patterns by Metro vs Non-Metro Counties
The figure above presents a faceted geographic view of U.S. counties grouped by metro classification (ismetro), showing the spatial distribution of K-means clusters based on log-adjusted cost shares. The left panel displays metro counties, while the right panel shows non-metro (rural) counties. Each color corresponds to one of the three clusters identified in the analysis.

Key Insights:

Metro Counties (Left Panel):
Cluster 3 (Blue) dominates much of the West Coast, including California, Washington, and parts of Oregon, and is also prevalent in parts of the Northeast and Florida.
These areas likely represent high-cost urban counties with elevated housing and childcare costs, requiring distinct cost structures.
Cluster 2 (Red) appears primarily in the South and parts of the Midwest, indicating moderate cost burdens with some variation in food and transportation shares.
Cluster 1 (Green) is scattered but present in metro counties in the Mountain West, Northern Midwest, and Southeastern U.S., possibly representing lower-cost metro areas or suburban belts.
Non-Metro Counties (Right Panel):
Cluster 1 (Green) becomes far more prominent in non-metro regions, dominating the central and western U.S. This suggests a distinct low-cost structure prevalent in rural areas.
These counties likely feature lower housing and tax burdens but may experience higher shares in transportation and food due to distance and infrastructure.
Cluster 2 (Red) remains substantial across the South, Southeast, and Appalachia, suggesting a moderate-cost profile but potentially higher food burden in these rural areas.
Cluster 3 (Blue) appears sporadically in non-metro areas—mostly in the Southwest and Western U.S. This may reflect outlier rural counties with unusually high costs (e.g., due to energy, housing scarcity, or tribal lands).
Analytical Implications:

Metro vs Non-Metro Distinction Matters:
The cluster distribution differs sharply between metro and non-metro counties, confirming that cost structures are not uniform across urban-rural divides.
Cluster 3’s urban skew suggests it may capture counties with complex and elevated cost burdens typical of major metropolitan areas.
Cluster 1’s dominance in rural areas implies a generally more affordable (but perhaps under-resourced) cost profile, reinforcing the need to consider geographic context when analyzing SNAP participation and residual burdens.
This faceted map supports the inclusion of ismetro as a covariate in modeling frameworks or further stratified analyses.

## Statistical Tests by Cluster
```{r stats-tests}
# ANOVA for each cost share variable across clusters
anova_res <- map_dfr(share_vars, function(v) {
  aov_model <- aov(as.formula(paste(v, '~ cluster_k')), data = df_comp)
  tidy(aov_model) %>%
    filter(term == "cluster_k") %>%
    mutate(variable = v)
})

# ANOVA table (formatted)
knitr::kable(
  anova_res,
  caption = "ANOVA: Cost Shares by Cluster"
) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Chi-squared test of metro status by cluster
ct <- table(df_comp$cluster_k, df_comp$ismetro)
print(ct)
print(chisq.test(ct))
```
**Interpretation:**
We ran one-way ANOVAs to test whether the mean cost share in each expenditure category significantly differs by the K-means clusters (cluster_k). All categories show extremely significant differences across clusters (p < 0.001), with F-statistics indicating substantial between-cluster variability. Notably:

Housing Share has the highest F-value, suggesting it's the most decisive factor distinguishing clusters.
Food and Transportation Shares also show large differences, reinforcing the economic logic behind cluster formation.
These findings validate the use of K-means clustering on cost structure, as the clusters are not arbitrary—they correspond to meaningful economic segmentation.

The second table shows a cross-tabulation of cluster membership (cluster_k) against metro status (ismetro), followed by a Pearson's Chi-squared test.

Chi-squared statistic: 699.24
Degrees of freedom: 2
p-value: < 2.2e-16
Interpretation:

There is a highly significant association between metro status and cluster membership. Specifically:

Cluster 3, which likely corresponds to high-cost counties, is dominantly metro: 485 out of 566 counties (~86%) in this cluster are metropolitan.
Clusters 1 and 2, on the other hand, are majority non-metro, comprising counties with moderate or lower adjusted cost shares.
This suggests that cost structure clusters are not spatially random, but reflect urban-rural divides.

Overall Conclusion:
The ANOVA confirms that the clusters differ systematically across all cost categories, especially housing and transportation. The Chi-squared test further reveals that these clusters are geographically patterned, with urban counties overrepresented in high-cost clusters. These patterns affirm the robustness of the clustering and highlight structural cost disparities between metro and non-metro regions.

```{r}
# Load knitr for kable
library(knitr)

# Create ANOVA summary table
anova_table <- data.frame(
  `Cost Category` = c("Food Share", "Housing Share", "Transport Share", "Health Share", "Childcare Share", "Tax Share"),
  `F-statistic` = c(1825.20, 2402.80, 1719.45, 632.86, 435.84, 534.51),
  `p-value` = rep("< 0.001", 6),
  `Interpretation` = c(
    "Significant differences across clusters",
    "Largest difference—clusters clearly stratified",
    "Strong differentiation by cluster",
    "Substantial variation across clusters",
    "Statistically significant differences",
    "Meaningful cost structure variation"
  )
)

# Display table
kable(anova_table, caption = "ANOVA: Cost Shares by Cluster", align = "lccc")

# Create contingency table
chi_table <- matrix(c(903, 359,
                      991, 325,
                       81, 485),
                    nrow = 3, byrow = TRUE)

# Add row and column names
rownames(chi_table) <- c("Cluster 1", "Cluster 2", "Cluster 3")
colnames(chi_table) <- c("Non-Metro", "Metro")

# Convert to data frame for kable
chi_df <- as.data.frame.matrix(chi_table)

# Display table
kable(chi_df, caption = "Cluster Membership by Metro Status", align = "lcc")

# Create raw table again
ct <- matrix(c(903, 359, 991, 325, 81, 485), ncol = 2, byrow = TRUE)

# Run Chi-squared test
chisq.test(ct)

```

## Final Diagnostics & Conclusion
```{r final-diag-ggplot, warning=FALSE, message=FALSE}
# Load required library
library(ggfortify)

# Fit linear model on PC1
mod1 <- lm(PC1 ~ snap_rate + median_family_income + ismetro + state_abv, data = df_pcs)

# Produce all 4 diagnostic plots in one
autoplot(mod1, label.size = 3) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```
**Interpretation:** 
🧪 Regression Diagnostic Plots for PC1 Model
The following diagnostic plots assess key assumptions of the linear regression model predicting PC1 from SNAP rate, income, metro status, and state fixed effects.

1. Residuals vs Fitted Plot

Purpose: Tests linearity and homoscedasticity (constant variance).
Interpretation: The residuals appear mostly centered around 0, but the slight curve in the blue line suggests mild non-linearity. There is some funneling at higher fitted values, indicating potential heteroscedasticity (i.e., variance of residuals increases with fitted values).
Implication: A transformation or robust standard errors might improve model fit.
2. Normal Q-Q Plot

Purpose: Checks the normality of residuals.
Interpretation: The residuals largely follow the diagonal line, but deviations at both tails suggest non-normality, especially with some very low outliers.
Implication: The non-normal tails could slightly affect p-values but are not severe enough to undermine the model if the sample is large.
3. Scale-Location Plot

Purpose: Tests for homoscedasticity (equal spread of residuals across fitted values).
Interpretation: The scatter is fairly random, but the downward curve in the smoother line again suggests slightly increasing variance at higher fitted values.
Implication: Confirms what was observed in the Residuals vs Fitted plot—mild heteroscedasticity may be present.
4. Residuals vs Leverage Plot

Purpose: Identifies influential observations.
Interpretation: Most points cluster in the lower-left region, but a few counties (e.g., points 563, 2316, 232) have moderate leverage and large residuals, indicating potential influence on the model.
Implication: These should be reviewed for data quality issues or high leverage effects. However, Cook’s distance appears low for most, so they are not unduly problematic.

**Conclusion:**
This analysis investigated whether and how SNAP participation rates reflect or reshape local cost structures across U.S. counties, using a combination of dimension reduction, regression modeling, clustering, and geographic visualization.

🔍 Data Preparation and Variable Construction
We began by compiling a comprehensive dataset of U.S. counties, merging SNAP participation rates, demographic data (e.g., income, metro status), and cost components (housing, food, healthcare, transportation, taxes, childcare). To ensure comparability across counties with vastly different total expenditures, we converted absolute costs into cost shares, and applied log-transformations to skewed components. This choice was validated through visual inspection and improved distributional symmetry for PCA and regression analysis.

🧮 Multicollinearity Check
To assess potential multicollinearity among cost share variables, we calculated Variance Inflation Factors (VIFs) for each component by rotating through response-predictor combinations. While some variables (e.g., food share, housing share) showed VIF values approaching or exceeding 5 when regressed on others, no component exceeded the common threshold of 10. As such, we retained all variables but remained cautious about interpretation, especially in multivariate modeling. This step ensured that our PCA and clustering results were not distorted by extreme redundancy.

🧠 Principal Component Analysis (PCA)
PCA was employed to reduce dimensionality and uncover latent patterns in county-level cost structures. The first three principal components (PCs) captured the vast majority of variance and were interpretable:

PC1 was dominated by housing and tax shares and appeared to represent structural affordability.
PC2 reflected variation in transport and childcare burdens.
PC3 contrasted healthcare and food burdens with other costs, suggesting a health-nutrition tradeoff.
By summarizing multivariate cost structures into fewer axes, PCA enabled cleaner regression modeling and clustering downstream.

📊 Regression Analysis: SNAP Rate and Cost Structure
We modeled each principal component as a function of SNAP participation rate, controlling for median family income, metro status, and state fixed effects.

The models revealed that:

SNAP rate was a strong, statistically significant predictor of all three PCs.
Specifically, higher SNAP rates were associated with lower PC1 scores, suggesting that high-SNAP counties tend to face higher housing and tax burdens, even after adjusting for income.
SNAP rates were positively associated with PC2, indicating elevated transport and childcare burdens.
For PC3, the negative coefficient implied greater healthcare or food-related burdens in high-SNAP areas.
These results support the hypothesis that SNAP participation is not merely a reflection of poverty but may correlate with unique structural cost configurations, potentially requiring broader policy attention beyond food assistance alone.

🌍 Clustering and County Typologies
We implemented K-means clustering using log-adjusted cost shares to group counties into structurally similar clusters. Silhouette analysis suggested k = 2 as optimal for cohesion, while the gap statistic favored k = 5. We settled on k = 3 as a practical compromise offering interpretability and spatial coherence.

Cluster interpretation revealed:

Cluster 1: Predominantly non-metro counties with low housing but high food and transport shares.
Cluster 2: Mixed metro and non-metro areas with elevated childcare and healthcare shares.
Cluster 3: Urbanized counties with high housing/tax burdens but lower food share.
This typology was validated via geographic mapping, showing clear regional and metro/non-metro patterns. A chi-squared test confirmed significant association between cluster membership and metro status, further supporting the relevance of spatial-economic context in cost structure.

📈 ANOVA and Statistical Testing
ANOVA results confirmed that cost shares differ significantly across clusters, with p-values < 0.001 across all components. This validates that the clusters capture meaningful structural differences, not arbitrary groupings.

Chi-squared analysis also revealed a strong association between SNAP participation (above/below median) and cluster membership, implying that the cost structure typologies are functionally related to public assistance demand.

🔬 Regression Diagnostics
Diagnostic plots for the PC1 model showed:

Mild heteroscedasticity and non-normal residual tails, though not severe enough to invalidate inference.
A few influential counties, but no undue leverage.
Overall, model fit was robust, especially given the large sample size.
Robustness could be improved in future work via generalized linear models or heteroskedasticity-consistent errors.

🧠 Final Synthesis
Our multi-method approach—grounded in data cleaning, PCA, regression, clustering, and visual analytics—provides compelling evidence that:

SNAP participation rates are not merely a proxy for income or poverty but are associated with distinct cost-of-living profiles across counties.
Counties with high SNAP uptake tend to have:

Higher housing and tax burdens (PC1),
Elevated transport and childcare pressures (PC2),
And complex tradeoffs in healthcare and food-related costs (PC3).
Furthermore, these counties cluster geographically and structurally in ways that align with metro/non-metro divides and state-level policy contexts.

These findings underscore the importance of place-based policy: while SNAP addresses food insecurity, complementary interventions may be needed to address the housing, childcare, and healthcare burdens that disproportionately affect high-SNAP counties.

📌 Policy Implications
Integrate SNAP with housing subsidies, especially in high-cost urban areas.
Tailor childcare and transport support for rural counties with high food burdens.
Use cluster typologies to target multi-sectoral interventions where cost pressures intersect.
</div>

```{r}
# Load required libraries
library(broom)
library(dplyr)
library(ggplot2)

# Regress each principal component on SNAP rate and controls
model_pc1 <- lm(PC1 ~ snap_rate + median_family_income + ismetro + state_abv, data = df_pcs)
model_pc2 <- lm(PC2 ~ snap_rate + median_family_income + ismetro + state_abv, data = df_pcs)
model_pc3 <- lm(PC3 ~ snap_rate + median_family_income + ismetro + state_abv, data = df_pcs)

# Summarize results
summary(model_pc1)
summary(model_pc2)
summary(model_pc3)

# Tidy summary for presentation
library(knitr)
kable(tidy(model_pc1), caption = "Regression Results: PC1 ~ SNAP + Controls")
kable(tidy(model_pc2), caption = "Regression Results: PC2 ~ SNAP + Controls")
kable(tidy(model_pc3), caption = "Regression Results: PC3 ~ SNAP + Controls")

```

```{r}
# Correlation Heatmap
library(corrplot)
cost_vars <- df %>% select(food_share, housing_share, transport_share, health_share, childcare_share, tax_share)
corr_matrix <- cor(cost_vars, use = "complete.obs")
png("correlation_heatmap.png", width = 800, height = 600)
corrplot(corr_matrix, method = "color", tl.cex = 0.8, addCoef.col = "black", number.cex = 0.7)
dev.off()

# Fit a regression model for PC1
pc_model1 <- lm(PC1 ~ snap_rate + median_family_income + metro + state_abv, data = df)

# Q-Q Plot
png("qq_plot.png", width = 800, height = 600)
qqnorm(resid(pc_model1))
qqline(resid(pc_model1), col = "red", lwd = 2)
dev.off()

# Residuals vs Fitted Plot
png("residual_plot.png", width = 800, height = 600)
plot(fitted(pc_model1), resid(pc_model1), 
     xlab = "Fitted values", ylab = "Residuals", 
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lwd = 2)
dev.off()

# PCA Scree Plot
png("pca_scree.png", width = 800, height = 600)
fviz_eig(pca_model)  # assuming pca_model is your PCA object
dev.off()

# Silhouette Plot for k-means
png("silhouette_plot.png", width = 800, height = 600)
fviz_silhouette(cluster::silhouette(kmeans_model$cluster, dist(pca_scores))) # adjust objects as needed
dev.off()
```

```{r}
# Either remove if unnecessary
# OR correct the incorrect column name:
# df <- df %>% rename(state_abv = state_abv.)

# Check the names before renaming:
names(df)


```

